
name: üöÄ SERVER HRGBVNGM PREMIUM üöÄ

on:
  workflow_dispatch:
    inputs:
      run_hours:
        description: 'Ch·ªçn th·ªùi gian ch·∫°y (1-6 gi·ªù)'
        required: true
        type: choice
        options: ['1', '2', '3', '4', '5', '6']
        default: '3'

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 390

    steps:
      - name: T·∫£i v√† gi·∫£i n√©n Ngrok (phi√™n b·∫£n stable m·ªõi nh·∫•t)
        run: |
          Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip
          Expand-Archive ngrok.zip -DestinationPath .
          .\ngrok.exe authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

      - name: B·∫≠t RDP, t·∫°o user v√† t·ªëi ∆∞u hi·ªáu su·∫•t
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

          $user = "rdpuser"
          $pass = "${{ secrets.RDP_PASSWORD }}"

          if (-Not $pass) {
            Write-Host "L·ªñI: Vui l√≤ng ƒë·∫∑t secret RDP_PASSWORD!"
            exit 1
          }

          if (-Not (Get-LocalUser -Name $user -ErrorAction SilentlyContinue)) {
            New-LocalUser -Name $user -Password (ConvertTo-SecureString $pass -AsPlainText -Force) -FullName "RDP User"
            Add-LocalGroupMember -Group "Administrators" -Member $user
            Add-LocalGroupMember -Group "Remote Desktop Users" -Member $user
          } else {
            Set-LocalUser -Name $user -Password (ConvertTo-SecureString $pass -AsPlainText -Force)
          }

          powercfg -setactive SCHEME_MIN
          Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Themes\Personalize' -Name "EnableTransparency" -Value 0
          Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name "TaskbarAnimations" -Value 0
          Stop-Service SysMain, DiagTrack -Force -ErrorAction SilentlyContinue

      - name: Kh·ªüi ƒë·ªông Ngrok tunnel v√† hi·ªÉn th·ªã th√¥ng tin k·∫øt n·ªëi
        run: |
          Start-Process -WindowStyle Hidden -FilePath ".\ngrok.exe" -ArgumentList "tcp 3389"

          Write-Host "RDP ƒë√£ s·∫µn s√†ng!"
          Write-Host "Th·ªùi gian ch·∫°y: ${{ inputs.run_hours }} gi·ªù"

          Write-Host "ƒêang ch·ªù Ngrok kh·ªüi t·∫°o tunnel..."

          Start-Sleep -Seconds 60

          $addr = ""
          for ($i = 1; $i -le 15; $i++) {
            try {
              $tunnel = Invoke-RestMethod http://localhost:4040/api/tunnels -ErrorAction Stop
              $addr = ($tunnel.tunnels | Where-Object proto -eq "tcp").public_url -replace "tcp://",""
              if ($addr) { 
                Write-Host "L·∫•y address th√†nh c√¥ng sau $i l·∫ßn th·ª≠!"
                break 
              }
            } catch {
              Write-Host "Retry l·∫ßn $i..."
            }
            Start-Sleep -Seconds 20
          }

          if (-not $addr) {
            Write-Host "L·ªñI: Kh√¥ng l·∫•y ƒë∆∞·ª£c tunnel Ngrok - Ki·ªÉm tra NGROK_AUTH_TOKEN!"
            exit 1
          }

          Write-Host "=== TH√îNG TIN K·∫æT N·ªêI RDP ==="
          Write-Host "Address: $addr"
          Write-Host "Username: rdpuser"
          Write-Host "Password: ${{ secrets.RDP_PASSWORD }}"
          Write-Host "=============================="

          Start-Sleep -Seconds (${{ inputs.run_hours }} * 3600)
