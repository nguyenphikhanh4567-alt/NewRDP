name: MÃY CHá»¦ PREMIUM Cá»¦A HEROGOODBOYVN

on:
  workflow_dispatch:
    inputs:
      run_hours:
        description: 'Chá»n thá»i gian mÃ¡y chá»§ cháº¡y (1-6 giá»)'
        required: true
        type: choice
        options: ['1', '2', '3', '4', '5', '6']
        default: '1'

jobs:
  premium-rdp-server:
    name: ğŸš€ MÃ¡y Chá»§ Premium HEROGOODBOYVN - Windows 11 Style RDP
    runs-on: windows-latest
    timeout-minutes: ${{ (inputs.run_hours || 1) * 60 }}

    env:
      ORIGINAL_OWNER: HEROGOODBOYVN
      RDP_USERNAME: HEROGOODBOYVN  # Thá»­ trÆ°á»›c, náº¿u lá»—i fallback admin

    steps:
      - name: Khá»Ÿi Äá»™ng MÃ¡y Chá»§ Premium
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "   MÃY CHá»¦ PREMIUM CHÃNH CHá»¦: $env:ORIGINAL_OWNER   "
          echo "   Thá»i gian cháº¡y: ${{ inputs.run_hours || 1 }} giá»   "
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Táº£i vÃ  cÃ i Ngrok
        run: |
          Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip
          Expand-Archive ngrok.zip -DestinationPath .
          .\ngrok\ngrok.exe authtoken ${{ secrets.NGROK_AUTH_TOKEN }} || (echo "FAIL NGROK TOKEN - Äi dashboard.ngrok.com copy token Má»šI paste láº¡i secret NGROK_AUTH_TOKEN ngay boss!" && exit 1)

      - name: Báº­t RDP & Táº¡o User + Tá»‘i Æ¯u
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1

          $username = "$env:RDP_USERNAME"
          $fallback_user = "admin"
          \( password = " \){{ secrets.RDP_PASSWORD || 'Nguyen2009' }}"

          # Thá»­ táº¡o user HEROGOODBOYVN, náº¿u lá»—i thÃ¬ dÃ¹ng admin
          try {
            if (-Not (Get-LocalUser -Name $username -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name $username -Password (ConvertTo-SecureString $password -AsPlainText -Force) -FullName "HEROGOODBOYVN Premium" -ErrorAction Stop
              Add-LocalGroupMember -Group "Administrators" -Member $username
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
              echo "Táº¡o user $username thÃ nh cÃ´ng! Premium max!"
            } else {
              net user $username $password
              echo "Update password $username ok!"
            }
            $final_user = $username
          } catch {
            echo "Lá»—i táº¡o user $username (cÃ³ thá»ƒ username dÃ i quÃ¡) - DÃ¹ng fallback admin nha boss!"
            net user administrator $password
            $final_user = "administrator"
          }

          # Tá»‘i Æ°u mÆ°á»£t
          powercfg -setactive SCHEME_MIN
          Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Themes\Personalize' -Name "EnableTransparency" -Value 0
          Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name "TaskbarAnimations" -Value 0
          Stop-Service -Name "SysMain" -Force -ErrorAction SilentlyContinue
          echo "Tá»‘i Æ°u xong - siÃªu mÆ°á»£t nghe nháº¡c!"

          # LÆ°u username cuá»‘i cÃ¹ng Ä‘á»ƒ dÃ¹ng sau
          echo "FINAL_RDP_USER=$final_user" >> $env:GITHUB_ENV

      - name: Khá»Ÿi cháº¡y Ngrok & Hiá»ƒn Thá»‹ Káº¿t Ná»‘i (Retry + Chá» DÃ i)
        run: |
          Start-Process -FilePath ".\ngrok\ngrok.exe" -ArgumentList "tcp 3389 --log=stdout" -NoNewWindow
          echo "Táº¡o tunnel... Chá» 60 giÃ¢y (siÃªu cháº¯c Äƒn) ğŸš€"
          Start-Sleep -Seconds 60

          # Retry láº¥y tunnel 3 láº§n náº¿u fail
          $success = $false
          for ($i=1; $i -le 3; $i++) {
            try {
              $tunnel = Invoke-RestMethod http://localhost:4040/api/tunnels -ErrorAction Stop
              $public_url = ($tunnel.tunnels | Where-Object { $_.proto -eq "tcp" }).public_url
              if ($public_url) {
                $host_port = $public_url -replace 'tcp://', ''
                $success = $true
                break
              }
            } catch {}
            echo "Retry láº¥y tunnel láº§n $i..."
            Start-Sleep -Seconds 20
          }

          if (-Not $success) {
            echo "FAIL TUNNEL SAU 3 Láº¦N - Cháº¡y láº¡i workflow + check token ngrok má»›i nháº¥t!"
            exit 1
          }

          $rdp_user = "$env:FINAL_RDP_USER"
          \( rdp_pass = " \){{ secrets.RDP_PASSWORD || 'Nguyen2009' }}"
          \( running_time = " \){{ inputs.run_hours || 1 }}"

          Write-Host ""
          Write-Host "ğŸŒŒâœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨ğŸŒŒ" -ForegroundColor Cyan
          Write-Host "   ğŸ”¥ MÃY CHá»¦ PREMIUM CHÃNH CHá»¦: HEROGOODBOYVN ğŸ”¥   " -ForegroundColor Magenta
          Write-Host "   ğŸ® Server tá»± xÃ¢y & tá»‘i Æ°u max mÆ°á»£t! ğŸ®   " -ForegroundColor Yellow
          Write-Host "ğŸŒŒâœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨ğŸŒŒ" -ForegroundColor Cyan
          Write-Host ""

          Write-Host "    ğŸ‘‘ CHá»¦ Sá» Há»®U: $env:ORIGINAL_OWNER ğŸ‘‘" -ForegroundColor Yellow
          Write-Host "         â±ï¸  Thá»i gian: $running_time giá»" -ForegroundColor Green
          Write-Host ""

          Write-Host "          ğŸ®ğŸ”¥ Káº¾T Ná»I THÃ€NH CÃ”NG ğŸ”¥ğŸ®" -ForegroundColor Cyan
          Write-Host "    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor White
          Write-Host "    â•‘  ğŸ“ Address:   $host_port          â•‘" -ForegroundColor Yellow
          Write-Host "    â•‘  ğŸ‘¤ Username: $rdp_user                â•‘" -ForegroundColor Yellow
          Write-Host "    â•‘  ğŸ”‘ Password: $rdp_pass                â•‘" -ForegroundColor Yellow
          Write-Host "    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor White
          Write-Host ""

          Write-Host "ğŸ“± CÃ¡ch connect: Microsoft Remote Desktop â†’ DÃ¡n address Ä‘áº§y Ä‘á»§ â†’ Connect chill!"
          Write-Host ""
          Write-Host "        ğŸ‰ BÃ‚Y GIá»œ CHáº®C CHáº®N CHáº Y Rá»’I BOSS, VÃ€O NGHE NHáº C ÄI! ğŸ‰" -ForegroundColor Magenta
          Write-Host "                   Premium by HEROGOODBOYVN âœ¨"
          Write-Host ""

      - name: Giá»¯ mÃ¡y chá»§ cháº¡y
        run: |
          echo "MÃ¡y chá»§ premium Ä‘ang cháº¡y á»•n Ä‘á»‹nh... Chill thÃ´i boss Æ¡i! ğŸš€ğŸ¶"
          Start-Sleep -Seconds ${{ (inputs.run_hours || 1) * 3600 }}
