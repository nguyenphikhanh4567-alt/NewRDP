name: Nguyễn Chí Dự Windows The Flash

on:
  workflow_dispatch:
    inputs:
      ngrok_download_url:
        description: 'Ngrok download link (default stable 2026)'
        required: true
        default: 'https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip'

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 370

    steps:
      - name: Download ngrok
        run: |
          Invoke-WebRequest -Uri "${{ inputs.ngrok_download_url }}" -OutFile ngrok.zip
          Expand-Archive ngrok.zip -DestinationPath .

      - name: Auth ngrok
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          if (-Not $Env:NGROK_AUTH_TOKEN) {
            Write-Host "LỖI: Chưa đặt secret NGROK_AUTH_TOKEN!"
            exit 1
          }
          .\ngrok.exe authtoken $Env:NGROK_AUTH_TOKEN

      - name: Setup RDP + Max Fast Intro + Reduce Lag
        run: |
          Rename-Computer -NewName "NCDuFlash" -Restart:$false
          Write-Host "Đã đổi tên PC thành: NCDuFlash"

          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

          $user = "NguyenChiDu"
          $pass = "W1nd0ws-P4ssw0rd-2025!"
          if (-Not (Get-LocalUser -Name $user -ErrorAction SilentlyContinue)) {
            New-LocalUser $user -Password (ConvertTo-SecureString -AsPlainText $pass -Force) -FullName "Nguyễn Chí Dự"
            Add-LocalGroupMember -Group "Remote Desktop Users" -Member $user
            Add-LocalGroupMember -Group "Administrators" -Member $user
          } else {
            Set-LocalUser $user -Password (ConvertTo-SecureString -AsPlainText $pass -Force)
          }

          Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects' -Name "VisualFXSetting" -Value 2
          Set-ItemProperty -Path 'HKCU:\Control Panel\Desktop\WindowMetrics' -Name "MinAnimate" -Value "0"
          Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced' -Name "TaskbarAnimations" -Value 0
          Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Themes\Personalize' -Name "EnableTransparency" -Value 0
          Set-ItemProperty -Path 'HKCU:\Control Panel\Desktop' -Name "DragFullWindows" -Value "0"
          New-Item -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Policies\ActiveDesktop' -Force | Out-Null
          Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Policies\ActiveDesktop' -Name "NoChangingWallPaper" -Value 1

          @("SysMain","WSearch","wuauserv","WinDefend","DiagTrack") | ForEach-Object {
            Stop-Service -Name $_ -Force -ErrorAction SilentlyContinue
            Set-Service -Name $_ -StartupType Disabled -ErrorAction SilentlyContinue
          }

          New-Item -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services' -Force | Out-Null
          Set-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services' -Name "MaxCompressionLevel" -Value 2 -Type DWord
          Set-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services' -Name "VideoQualityMode" -Value 2 -Type DWord
          Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "fEnableDesktopComposition" -Value 0
          New-Item -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations' -Force | Out-Null
          Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations' -Name "DWMFRAMEINTERVAL" -Value 10 -Type DWord

      - name: Start Ngrok Tunnel (Hidden) & Display RDP Info
        run: |
          Write-Host "=================================================="
          Write-Host "NGUYỄN CHÍ DỰ WINDOWS THE FLASH - RDP SẴN SÀNG!"
          Write-Host "Tên chủ: Nguyễn Chí Dự"
          Write-Host "Username: NguyenChiDu"
          Write-Host "Password: W1nd0ws-P4ssw0rd-2025!"
          Write-Host "Intro The Flash + Lag giảm max"
          Write-Host "=================================================="

          Start-Process -WindowStyle Hidden -FilePath ".\ngrok.exe" -ArgumentList "tcp 3389 --log=stdout"

          Start-Sleep -Seconds 45

          $addr = ""
          $i = 1
          while ($i -le 30 -and -not $addr) {
            try {
              $tunnels = Invoke-RestMethod http://localhost:4040/api/tunnels -ErrorAction Stop
              $tcpTunnel = $tunnels.tunnels | Where-Object { $_.proto -eq "tcp" }
              if ($tcpTunnel) {
                $addr = $tcpTunnel.public_url -replace 'tcp://', ''
                Write-Host "Lấy tunnel thành công sau $i lần thử!"
              }
            } catch {
              Write-Host "Đang chờ Ngrok tunnel... (lần $i/30)"
            }
            if (-not $addr) { Start-Sleep -Seconds 15 }
            $i++
